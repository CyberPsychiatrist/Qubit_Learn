<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qubit Learn - Donate</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header>
        <h1>Support Qubit Learn</h1>
        <nav>
            <a href="/">Home</a>
            <a href="/dashboard">Dashboard</a>
            <a href="/upload">Upload</a>
            <a href="/flashcards">Flashcards</a>
        </nav>
    </header>
    <main>
        <section class="donate-section">
            <h2>Make a Donation</h2>
      <form id="donateForm">
        <label>Amount (KES): <input type="number" name="amount" placeholder="Amount" required></label><br>
        <label>Email: <input type="email" name="email" placeholder="Email" required></label><br>
        <label>Phone (for M-Pesa): <input type="tel" name="phone" placeholder="Phone"></label><br>
        <label>Payment Method:
          <select name="method">
            <option value="card">Card</option>
            <option value="mpesa">M-Pesa</option>
          </select>
        </label><br>
        <button type="submit">Donate</button>
      </form>
      <div id="donateError" style="color:red;margin-top:1em;"></div>
      <script>
      document.getElementById('donateForm').onsubmit = async function(e) {
        e.preventDefault();
        const errorDiv = document.getElementById('donateError');
        errorDiv.innerText = '';
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Processing...';
        submitBtn.disabled = true;

        const form = this;
        const amount = form.amount.value;
        const email = form.email.value;
        const phone = form.phone.value;
        const method = form.method.value;

        try {
          let res, data;

          if (method === 'card') {
            console.log('Sending card payment request...');
            res = await fetch('/donate/checkout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ amount: parseFloat(amount), email, currency: 'KES' })
            });
            data = await res.json();
            console.log("Card payment response:", data);
            
            if (!res.ok) {
              throw new Error(data.detail || data.error || 'Card payment failed');
            }
            
            if (data.checkout_url) {
              console.log("Redirecting to checkout URL:", data.checkout_url);
              window.location.href = data.checkout_url;
              return;
            } else {
              throw new Error('No checkout URL received from payment processor');
            }
          } else if (method === 'mpesa') {
            if (!phone) {
              throw new Error('Phone number is required for M-Pesa payment');
            }
            
            console.log('Sending M-Pesa STK request...');
            res = await fetch('/donate/mpesa-stk', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ amount: parseFloat(amount), email, phone, currency: 'KES' })
            });
            data = await res.json();
            console.log("M-Pesa payment response:", data);
            
            if (!res.ok) {
              throw new Error(data.detail || data.error || 'M-Pesa payment failed');
            }
            
            if (data.status === 'PENDING') {
              alert('STK Push sent! Complete payment on your phone.');
              // Reset form
              form.reset();
              return;
            } else {
              throw new Error('M-Pesa payment request did not return expected status');
            }
          }

          // If we get here, there was an unexpected response
          throw new Error('Unexpected payment response');

        } catch (err) {
          console.error("Payment error:", err);
          let errorMessage = err.message || 'Payment failed. Please try again.';
          
          // Handle specific error messages
          if (errorMessage.includes('authentication token')) {
            errorMessage = 'Payment service error: Please contact support if this persists.';
          } else if (errorMessage.includes('missing fields')) {
            errorMessage = 'Payment service error: Invalid payment parameters.';
          } else if (errorMessage.includes('network')) {
            errorMessage = 'Network error: Please check your connection and try again.';
          }
          
          errorDiv.innerText = errorMessage;
          errorDiv.style.color = '#dc3545';
        } finally {
          // Reset button state
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      };
      </script>
</body>
</html>
